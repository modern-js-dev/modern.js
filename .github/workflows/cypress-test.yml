name: Cypress Test

concurrency:
  group: macos-test-${{ github.head_ref }}
  cancel-in-progress: true

# Controls when the action will run.
on:
  # Triggers unit test on push events for the main branch to collect unit test coverage
  push:
    branches: [main]
  # Triggers the workflow on pull request events but only for the main branch
  pull_request:
    branches: [main]


jobs:
  e2e-test:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        node-version: [16.14.0]
    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}
    - uses: pnpm/action-setup@v2.0.1
      name: Install pnpm
      id: pnpm-install
      with:
        version: 6.32.17
        run_install: false
    - name: wireit cache
      uses: google/wireit@setup-github-actions-caching/v1
    - name: install dependency
      run: pnpm install --ignore-scripts
    - name: Prepare
      run: pnpm run prepare --filter ./packages
    - name: Run cypress test
      uses: cypress-io/github-action@v2
      with:
        install: false
        start: node scripts/devCypress.js
        wait-on: 'http://localhost:3001,http://localhost:3002,http://localhost:3003'
        wait-on-timeout: 600
        parallel: true
        record: true
        spec: tests/cypress/e2e/**/*
      env:
        CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
        # Recommended: pass the GitHub token lets this action correctly
        # determine the unique run id necessary to re-run the checks
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
